local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")
local LP = Players.LocalPlayer
local UserInputService = game:GetService("UserInputService")

-- Настройки
local COIN_LIMITS = {40, 50}
local currentCoinLimit = 40

-- Создаем основной интерфейс
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "DekoUI"
ScreenGui.Parent = game.Players.LocalPlayer:WaitForChild("PlayerGui")

local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 450, 0, 200)
MainFrame.Position = UDim2.new(0.5, -225, 0.5, -100)
MainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
MainFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
MainFrame.BorderSizePixel = 0
MainFrame.Parent = ScreenGui

-- Скругление углов
local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 6)
UICorner.Parent = MainFrame

local TitleBar = Instance.new("Frame")
TitleBar.Name = "TitleBar"
TitleBar.Size = UDim2.new(1, 0, 0, 25)
TitleBar.Position = UDim2.new(0, 0, 0, 0)
TitleBar.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
TitleBar.BorderSizePixel = 0
TitleBar.Parent = MainFrame

-- Скругление только сверху
local UICornerTitle = Instance.new("UICorner")
UICornerTitle.CornerRadius = UDim.new(0, 6)
UICornerTitle.Parent = TitleBar

local Title = Instance.new("TextLabel")
Title.Name = "Title"
Title.Size = UDim2.new(0, 100, 1, 0)
Title.Position = UDim2.new(0, 10, 0, 0)
Title.BackgroundTransparency = 1
Title.Text = "Deko"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 14
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.Parent = TitleBar

-- Кнопки управления
local MinimizeButton = Instance.new("TextButton")
MinimizeButton.Name = "MinimizeButton"
MinimizeButton.Size = UDim2.new(0, 25, 0, 25)
MinimizeButton.Position = UDim2.new(1, -50, 0, 0)
MinimizeButton.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
MinimizeButton.BorderSizePixel = 0
MinimizeButton.Text = "-"
MinimizeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
MinimizeButton.Font = Enum.Font.GothamBold
MinimizeButton.TextSize = 16
MinimizeButton.Parent = TitleBar

local CloseButton = Instance.new("TextButton")
CloseButton.Name = "CloseButton"
CloseButton.Size = UDim2.new(0, 25, 0, 25)
CloseButton.Position = UDim2.new(1, -25, 0, 0)
CloseButton.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
CloseButton.BorderSizePixel = 0
CloseButton.Text = "X"
CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseButton.Font = Enum.Font.GothamBold
CloseButton.TextSize = 14
CloseButton.Parent = TitleBar

-- Эффекты кнопок
CloseButton.MouseEnter:Connect(function()
    CloseButton.BackgroundColor3 = Color3.fromRGB(220, 50, 50)
end)

CloseButton.MouseLeave:Connect(function()
    CloseButton.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
end)

MinimizeButton.MouseEnter:Connect(function()
    MinimizeButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
end)

MinimizeButton.MouseLeave:Connect(function()
    MinimizeButton.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
end)

-- Вкладки
local TabButtons = Instance.new("Frame")
TabButtons.Name = "TabButtons"
TabButtons.Size = UDim2.new(0, 80, 1, -25)
TabButtons.Position = UDim2.new(0, 0, 0, 25)
TabButtons.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
TabButtons.BorderSizePixel = 0
TabButtons.Parent = MainFrame

local Tabs = {"Farm", "ESP", "Fun"}
local TabFrames = {}

for i, tabName in ipairs(Tabs) do
    local TabButton = Instance.new("TextButton")
    TabButton.Name = tabName.."Tab"
    TabButton.Size = UDim2.new(1, 0, 0, 30)
    TabButton.Position = UDim2.new(0, 0, 0, (i-1)*30)
    TabButton.Text = tabName
    TabButton.BackgroundColor3 = i == 1 and Color3.fromRGB(40, 40, 40) or Color3.fromRGB(30, 30, 30)
    TabButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    TabButton.Font = Enum.Font.Gotham
    TabButton.TextSize = 12
    TabButton.BorderSizePixel = 0
    TabButton.Parent = TabButtons
    
    local TabFrame = Instance.new("Frame")
    TabFrame.Name = tabName.."Frame"
    TabFrame.Size = UDim2.new(1, -80, 1, -25)
    TabFrame.Position = UDim2.new(0, 80, 0, 25)
    TabFrame.BackgroundTransparency = 1
    TabFrame.Visible = i == 1
    TabFrame.Parent = MainFrame
    
    TabFrames[tabName] = TabFrame
    
    TabButton.MouseButton1Click:Connect(function()
        for _, frame in pairs(TabFrames) do
            frame.Visible = false
        end
        TabFrame.Visible = true
        
        for _, btn in ipairs(TabButtons:GetChildren()) do
            if btn:IsA("TextButton") then
                btn.BackgroundColor3 = btn == TabButton and Color3.fromRGB(40, 40, 40) or Color3.fromRGB(30, 30, 30)
            end
        end
    end)
end

-- Функционал сворачивания
local minimized = false
local originalSize = MainFrame.Size

MinimizeButton.MouseButton1Click:Connect(function()
    minimized = not minimized
    if minimized then
        MainFrame.Size = UDim2.new(0, 80, 0, 25)
        for _, frame in pairs(TabFrames) do
            frame.Visible = false
        end
    else
        MainFrame.Size = originalSize
        TabFrames["Farm"].Visible = true
    end
end)

CloseButton.MouseButton1Click:Connect(function()
    ScreenGui:Destroy()
end)

-- Элементы управления фармом
local FarmFrame = TabFrames["Farm"]
local farmingEnabled = false
local resetOnFullEnabled = false
local HRP, Humanoid

local function createToggle(name, posY, defaultValue, callback)
    local ToggleFrame = Instance.new("Frame")
    ToggleFrame.Name = name.."Toggle"
    ToggleFrame.Size = UDim2.new(0, 150, 0, 30)
    ToggleFrame.Position = UDim2.new(0, 20, 0, posY)
    ToggleFrame.BackgroundTransparency = 1
    ToggleFrame.Parent = FarmFrame
    
    local ToggleButton = Instance.new("TextButton")
    ToggleButton.Name = "Button"
    ToggleButton.Size = UDim2.new(0, 40, 0, 20)
    ToggleButton.Position = UDim2.new(0, 100, 0.5, -10)
    ToggleButton.Text = ""
    ToggleButton.BackgroundColor3 = defaultValue and Color3.fromRGB(0, 170, 0) or Color3.fromRGB(60, 60, 60)
    ToggleButton.AutoButtonColor = false
    ToggleButton.BorderSizePixel = 0
    ToggleButton.Parent = ToggleFrame
    
    local UICorner = Instance.new("UICorner")
    UICorner.CornerRadius = UDim.new(0, 10)
    UICorner.Parent = ToggleButton
    
    local ToggleText = Instance.new("TextLabel")
    ToggleText.Name = "Text"
    ToggleText.Size = UDim2.new(0, 90, 1, 0)
    ToggleText.Position = UDim2.new(0, 0, 0, 0)
    ToggleText.Text = name
    ToggleText.TextColor3 = Color3.fromRGB(255, 255, 255)
    ToggleText.Font = Enum.Font.Gotham
    ToggleText.TextSize = 12
    ToggleText.TextXAlignment = Enum.TextXAlignment.Left
    ToggleText.BackgroundTransparency = 1
    ToggleText.Parent = ToggleFrame
    
    local function updateState(state)
        ToggleButton.BackgroundColor3 = state and Color3.fromRGB(0, 170, 0) or Color3.fromRGB(60, 60, 60)
        callback(state)
    end
    
    ToggleButton.MouseButton1Click:Connect(function()
        updateState(not defaultValue)
        defaultValue = not defaultValue
    end)
    
    return {Update = updateState}
end

local function createDropdown(name, posY, options, defaultIndex, callback)
    local DropdownFrame = Instance.new("Frame")
    DropdownFrame.Name = name.."Dropdown"
    DropdownFrame.Size = UDim2.new(0, 150, 0, 30)
    DropdownFrame.Position = UDim2.new(0, 20, 0, posY)
    DropdownFrame.BackgroundTransparency = 1
    DropdownFrame.Parent = FarmFrame
    
    local DropdownButton = Instance.new("TextButton")
    DropdownButton.Name = "Button"
    DropdownButton.Size = UDim2.new(0, 60, 0, 25)
    DropdownButton.Position = UDim2.new(0, 80, 0.5, -12)
    DropdownButton.Text = options[defaultIndex]
    DropdownButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    DropdownButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    DropdownButton.Font = Enum.Font.Gotham
    DropdownButton.TextSize = 12
    DropdownButton.BorderSizePixel = 0
    DropdownButton.Parent = DropdownFrame
    
    local UICorner = Instance.new("UICorner")
    UICorner.CornerRadius = UDim.new(0, 4)
    UICorner.Parent = DropdownButton
    
    local DropdownText = Instance.new("TextLabel")
    DropdownText.Name = "Text"
    DropdownText.Size = UDim2.new(0, 70, 1, 0)
    DropdownText.Position = UDim2.new(0, 0, 0, 0)
    DropdownText.Text = name
    DropdownText.TextColor3 = Color3.fromRGB(255, 255, 255)
    DropdownText.Font = Enum.Font.Gotham
    DropdownText.TextSize = 12
    DropdownText.TextXAlignment = Enum.TextXAlignment.Left
    DropdownText.BackgroundTransparency = 1
    DropdownText.Parent = DropdownFrame
    
    local currentIndex = defaultIndex
    
    DropdownButton.MouseButton1Click:Connect(function()
        currentIndex = currentIndex % #options + 1
        DropdownButton.Text = options[currentIndex]
        callback(currentIndex)
    end)
    
    return {
        Update = function(index)
            currentIndex = index
            DropdownButton.Text = options[currentIndex]
            callback(currentIndex)
        end
    }
end

-- Создаем элементы управления
local CoinFarmToggle = createToggle("Auto Farm", 20, farmingEnabled, function(state)
    farmingEnabled = state
end)

local ResetOnFullToggle = createToggle("Reset On Full", 60, resetOnFullEnabled, function(state)
    resetOnFullEnabled = state
end)

local CoinLimitDropdown = createDropdown("Coin Limit", 100, {"40", "50"}, 1, function(index)
    currentCoinLimit = COIN_LIMITS[index]
end)

-- Функции фарма
local function getHRP()
    while true do
        if LP.Character and LP.Character:FindFirstChild("HumanoidRootPart") then
            return LP.Character.HumanoidRootPart
        end
        task.wait(0.1)
    end
end

local function getHumanoid()
    while true do
        if LP.Character and LP.Character:FindFirstChild("Humanoid") then
            return LP.Character.Humanoid
        end
        task.wait(0.1)
    end
end

local function refreshCharacter()
    HRP = getHRP()
    Humanoid = getHumanoid()
end

local function GetMap()
    while true do
        for _, obj in ipairs(workspace:GetChildren()) do
            if obj:GetAttribute("MapID") and obj:FindFirstChild("CoinContainer") then
                return obj
            end
        end
        task.wait(0.1)
    end
end

local function getNearest()
    if not HRP then return nil end
    
    local map = GetMap()
    local closest, dist = nil, math.huge
    
    for _, coin in ipairs(map.CoinContainer:GetChildren()) do
        local v = coin:FindFirstChild("CoinVisual")
        if v and not v:GetAttribute("Collected") then
            local d = (HRP.Position - coin.Position).Magnitude
            if d < dist then
                closest = coin
                dist = d
            end
        end
    end
    
    return closest
end

local function tpToCoin(coin)
    if not HRP or not Humanoid then return false end
    
    Humanoid:ChangeState(11)
    local distance = (HRP.Position - coin.Position).Magnitude
    local tween = TweenService:Create(
        HRP,
        TweenInfo.new(distance / 25, Enum.EasingStyle.Linear),
        {CFrame = coin.CFrame}
    )
    
    tween:Play()
    tween.Completed:Wait()
    return true
end

-- Функция для проверки количества монет и смерти при необходимости
local function checkCoinLimit()
    if not resetOnFullEnabled then return end
    
    -- Здесь должна быть логика проверки количества собранных монет
    -- Например, если у вас есть способ получить текущее количество монет:
    -- local currentCoins = получить_количество_монет()
    -- if currentCoins >= currentCoinLimit then
    --     Humanoid.Health = 0
    -- end
    
    -- Временная заглушка (замените на реальную логику)
    print("Проверка лимита монет: ", currentCoinLimit)
end

-- Основной цикл фарма
local function farmCoins()
    refreshCharacter()
    LP.CharacterAdded:Connect(function()
        refreshCharacter()
    end)

    while true do
        if farmingEnabled then
            -- Ждем пока игрок жив
            while not LP:GetAttribute("Alive") do
                task.wait(0.5)
            end
            
            -- Проверяем наличие персонажа
            if not LP.Character or not HRP or not Humanoid then
                refreshCharacter()
                task.wait(1)
                continue
            end
            
            -- Проверяем лимит монет
            checkCoinLimit()
            
            -- Ищем ближайшую монету
            local target = getNearest()
            
            if target then
                -- Пытаемся телепортироваться
                local success = pcall(function()
                    tpToCoin(target)
                end)
                
                if not success then
                    refreshCharacter()
                end
                
                -- Ожидаем пока монета не будет собрана
                local v = target:FindFirstChild("CoinVisual")
                while v and not v:GetAttribute("Collected") and v.Parent do
                    if not LP:GetAttribute("Alive") then break end
                    
                    -- Проверяем не появилась ли более близкая монета
                    local newTarget = getNearest()
                    if newTarget and newTarget ~= target then
                        target = newTarget
                        break
                    end
                    
                    task.wait(0.1)
                end
            end
        end
        task.wait(0.1)
    end
end

-- Запускаем фарм в отдельном потоке
coroutine.wrap(farmCoins)()

-- Делаем окно перемещаемым
local dragging
local dragInput
local dragStart
local startPos

local function update(input)
    local delta = input.Position - dragStart
    MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end

TitleBar.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = MainFrame.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

TitleBar.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement and dragging then
        dragInput = input
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        update(input)
    end
end)
