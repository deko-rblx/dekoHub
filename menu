local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")
local LP = Players.LocalPlayer
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

-- Создаем основной интерфейс
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "DekoUI"
ScreenGui.Parent = game.Players.LocalPlayer:WaitForChild("PlayerGui")

local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 300, 0, 350)
MainFrame.Position = UDim2.new(0.5, -150, 0.5, -175)
MainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
MainFrame.BorderSizePixel = 0
MainFrame.ClipsDescendants = true
MainFrame.Parent = ScreenGui

-- Скругление углов
local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 8)
UICorner.Parent = MainFrame

local TitleBar = Instance.new("Frame")
TitleBar.Name = "TitleBar"
TitleBar.Size = UDim2.new(1, 0, 0, 30)
TitleBar.Position = UDim2.new(0, 0, 0, 0)
TitleBar.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
TitleBar.BorderSizePixel = 0
TitleBar.Parent = MainFrame

local UICornerTitle = Instance.new("UICorner")
UICornerTitle.CornerRadius = UDim.new(0, 8)
UICornerTitle.Parent = TitleBar

local Title = Instance.new("TextLabel")
Title.Name = "Title"
Title.Size = UDim2.new(1, -40, 1, 0)
Title.Position = UDim2.new(0, 10, 0, 0)
Title.BackgroundTransparency = 1
Title.Text = "Deko"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 16
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.Parent = TitleBar

local CloseButton = Instance.new("TextButton")
CloseButton.Name = "CloseButton"
CloseButton.Size = UDim2.new(0, 30, 0, 30)
CloseButton.Position = UDim2.new(1, -30, 0, 0)
CloseButton.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
CloseButton.BorderSizePixel = 0
CloseButton.Text = "X"
CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseButton.Font = Enum.Font.GothamBold
CloseButton.TextSize = 14
CloseButton.Parent = TitleBar

CloseButton.MouseButton1Click:Connect(function()
    ScreenGui:Destroy()
end)

CloseButton.MouseEnter:Connect(function()
    CloseButton.BackgroundColor3 = Color3.fromRGB(220, 50, 50)
end)

CloseButton.MouseLeave:Connect(function()
    CloseButton.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
end)

local TabButtons = Instance.new("Frame")
TabButtons.Name = "TabButtons"
TabButtons.Size = UDim2.new(1, 0, 0, 35)
TabButtons.Position = UDim2.new(0, 0, 0, 30)
TabButtons.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
TabButtons.BorderSizePixel = 0
TabButtons.Parent = MainFrame

local Tabs = {"Farm", "ESP", "Fun"}
local TabFrames = {}

for i, tabName in ipairs(Tabs) do
    local TabButton = Instance.new("TextButton")
    TabButton.Name = tabName.."Tab"
    TabButton.Size = UDim2.new(1/#Tabs, -2, 1, 0)
    TabButton.Position = UDim2.new((i-1)/#Tabs, 0, 0, 0)
    TabButton.Text = tabName
    TabButton.BackgroundColor3 = i == 1 and Color3.fromRGB(40, 40, 40) or Color3.fromRGB(25, 25, 25)
    TabButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    TabButton.Font = Enum.Font.Gotham
    TabButton.TextSize = 14
    TabButton.BorderSizePixel = 0
    TabButton.Parent = TabButtons
    
    local TabFrame = Instance.new("ScrollingFrame")
    TabFrame.Name = tabName.."Frame"
    TabFrame.Size = UDim2.new(1, -10, 1, -75)
    TabFrame.Position = UDim2.new(0, 5, 0, 65)
    TabFrame.BackgroundTransparency = 1
    TabFrame.Visible = i == 1
    TabFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
    TabFrame.AutomaticCanvasSize = Enum.AutomaticSize.Y
    TabFrame.ScrollBarThickness = 5
    TabFrame.ScrollBarImageColor3 = Color3.fromRGB(100, 100, 100)
    TabFrame.Parent = MainFrame
    
    TabFrames[tabName] = TabFrame
    
    TabButton.MouseButton1Click:Connect(function()
        for _, frame in pairs(TabFrames) do
            frame.Visible = false
        end
        TabFrame.Visible = true
        
        for _, btn in ipairs(TabButtons:GetChildren()) do
            if btn:IsA("TextButton") then
                btn.BackgroundColor3 = btn == TabButton and Color3.fromRGB(40, 40, 40) or Color3.fromRGB(25, 25, 25)
            end
        end
    end)
end

-- Функции для фарма монет
local farmingEnabled = false
local resetOnFull = false
local HRP, Humanoid

local function createToggle(name, parent, defaultValue, callback)
    local ToggleFrame = Instance.new("Frame")
    ToggleFrame.Name = name.."Toggle"
    ToggleFrame.Size = UDim2.new(1, -20, 0, 30)
    ToggleFrame.Position = UDim2.new(0, 10, 0, 0)
    ToggleFrame.BackgroundTransparency = 1
    ToggleFrame.Parent = parent
    
    local ToggleButton = Instance.new("TextButton")
    ToggleButton.Name = "Button"
    ToggleButton.Size = UDim2.new(0, 50, 0, 25)
    ToggleButton.Position = UDim2.new(1, -50, 0.5, -12)
    ToggleButton.Text = ""
    ToggleButton.BackgroundColor3 = defaultValue and Color3.fromRGB(0, 170, 0) or Color3.fromRGB(60, 60, 60)
    ToggleButton.AutoButtonColor = false
    ToggleButton.BorderSizePixel = 0
    ToggleButton.Parent = ToggleFrame
    
    local UICorner = Instance.new("UICorner")
    UICorner.CornerRadius = UDim.new(1, 0)
    UICorner.Parent = ToggleButton
    
    local ToggleCircle = Instance.new("Frame")
    ToggleCircle.Name = "Circle"
    ToggleCircle.Size = UDim2.new(0, 21, 0, 21)
    ToggleCircle.Position = UDim2.new(0, defaultValue and 29 or 2, 0.5, -10)
    ToggleCircle.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    ToggleCircle.BorderSizePixel = 0
    ToggleCircle.Parent = ToggleButton
    
    local UICornerCircle = Instance.new("UICorner")
    UICornerCircle.CornerRadius = UDim.new(1, 0)
    UICornerCircle.Parent = ToggleCircle
    
    local ToggleText = Instance.new("TextLabel")
    ToggleText.Name = "Text"
    ToggleText.Size = UDim2.new(1, -60, 1, 0)
    ToggleText.Position = UDim2.new(0, 0, 0, 0)
    ToggleText.Text = name
    ToggleText.TextColor3 = Color3.fromRGB(255, 255, 255)
    ToggleText.Font = Enum.Font.Gotham
    ToggleText.TextSize = 14
    ToggleText.TextXAlignment = Enum.TextXAlignment.Left
    ToggleText.BackgroundTransparency = 1
    ToggleText.Parent = ToggleFrame
    
    local function updateState(state)
        farmingEnabled = state
        ToggleButton.BackgroundColor3 = state and Color3.fromRGB(0, 170, 0) or Color3.fromRGB(60, 60, 60)
        local tweenInfo = TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.InOut)
        local tween = TweenService:Create(
            ToggleCircle,
            tweenInfo,
            {Position = UDim2.new(0, state and 29 or 2, 0.5, -10)}
        )
        tween:Play()
        callback(state)
    end
    
    ToggleButton.MouseButton1Click:Connect(function()
        updateState(not farmingEnabled)
    end)
    
    return {Update = updateState}
end

-- Создаем элементы управления фармом
local FarmFrame = TabFrames["Farm"]

local CoinFarmToggle = createToggle("Auto Farm", FarmFrame, farmingEnabled, function(state)
    farmingEnabled = state
end)

local ResetOnFullToggle = createToggle("Reset On Full", FarmFrame, resetOnFull, function(state)
    resetOnFull = state
end)

-- Добавляем отступ между элементами
local UIPadding = Instance.new("UIPadding")
UIPadding.PaddingTop = UDim.new(0, 10)
UIPadding.Parent = FarmFrame

-- Функции для фарма
local function getHRP()
    while true do
        if LP.Character and LP.Character:FindFirstChild("HumanoidRootPart") then
            return LP.Character.HumanoidRootPart
        end
        task.wait(0.1)
    end
end

local function getHumanoid()
    while true do
        if LP.Character and LP.Character:FindFirstChild("Humanoid") then
            return LP.Character.Humanoid
        end
        task.wait(0.1)
    end
end

local function refreshCharacter()
    HRP = getHRP()
    Humanoid = getHumanoid()
end

local function GetMap()
    while true do
        for _, obj in ipairs(workspace:GetChildren()) do
            if obj:GetAttribute("MapID") and obj:FindFirstChild("CoinContainer") then
                return obj
            end
        end
        task.wait(0.1)
    end
end

local function getNearest()
    if not HRP then return nil end
    
    local map = GetMap()
    local closest, dist = nil, math.huge
    
    for _, coin in ipairs(map.CoinContainer:GetChildren()) do
        local v = coin:FindFirstChild("CoinVisual")
        if v and not v:GetAttribute("Collected") then
            local d = (HRP.Position - coin.Position).Magnitude
            if d < dist then
                closest = coin
                dist = d
            end
        end
    end
    
    return closest
end

local function tpToCoin(coin)
    if not HRP or not Humanoid then return false end
    
    Humanoid:ChangeState(11)
    local distance = (HRP.Position - coin.Position).Magnitude
    local tween = TweenService:Create(
        HRP,
        TweenInfo.new(distance / 25, Enum.EasingStyle.Linear),
        {CFrame = coin.CFrame}
    )
    
    tween:Play()
    tween.Completed:Wait()
    return true
end

-- Основной цикл фарма
local function farmCoins()
    refreshCharacter()
    LP.CharacterAdded:Connect(function()
        refreshCharacter()
    end)

    while true do
        if farmingEnabled then
            -- Ждем пока игрок жив
            while not LP:GetAttribute("Alive") do
                task.wait(0.5)
            end
            
            -- Проверяем наличие персонажа
            if not LP.Character or not HRP or not Humanoid then
                refreshCharacter()
                task.wait(1)
                continue
            end
            
            -- Ищем ближайшую монету
            local target = getNearest()
            
            if target then
                -- Пытаемся телепортироваться
                local success = pcall(function()
                    tpToCoin(target)
                end)
                
                if not success then
                    refreshCharacter()
                end
                
                -- Ожидаем пока монета не будет собрана
                local v = target:FindFirstChild("CoinVisual")
                while v and not v:GetAttribute("Collected") and v.Parent do
                    if not LP:GetAttribute("Alive") then break end
                    
                    -- Проверяем не появилась ли более близкая монета
                    local newTarget = getNearest()
                    if newTarget and newTarget ~= target then
                        target = newTarget
                        break
                    end
                    
                    task.wait(0.1)
                end
            end
        end
        task.wait(0.1)
    end
end

-- Запускаем фарм в отдельном потоке
coroutine.wrap(farmCoins)()

-- Делаем окно перемещаемым
local dragging
local dragInput
local dragStart
local startPos

local function update(input)
    local delta = input.Position - dragStart
    MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end

TitleBar.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = MainFrame.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

TitleBar.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement and dragging then
        dragInput = input
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        update(input)
    end
end)
